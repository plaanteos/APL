// ================================================================
// SCHEMA PRISMA - MODELO OFICIAL DEL SECTOR BD
// Fecha: 15 de enero de 2026
// Fuente: Diccionario_Datos_APL.xlsx + MR APP APL.jpg
// Base de datos: PostgreSQL 14+
// ================================================================

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================================================================
// TABLA: administrador
// ================================================================
model Administrador {
  id            Int       @id @default(autoincrement())
  nombre        String    @db.VarChar(100)
  telefono      String    @db.VarChar(20)
  email         String    @db.VarChar(100) @unique
  usuario       String    @db.VarChar(50) @unique
  super_usuario Boolean   @default(false)
  password      String    // Hash con bcryptjs
  
  // Timestamps (agregados para funcionalidad, no en diccionario)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Campos funcionales (no en diccionario oficial pero necesarios)
  activo        Boolean   @default(true)
  refreshToken  String?   @db.Text
  
  // Password recovery fields
  resetPasswordToken   String?   @db.Text
  resetPasswordExpiry  DateTime?
  
  // Relaciones según MR
  clientes      Cliente[]
  pedidos       Pedido[]
  productos     Producto[]
  pagos         Pago[]
  
  @@map("administrador")
}

// ================================================================
// TABLA: cliente
// ================================================================
model Cliente {
  id                Int       @id @default(autoincrement())
  nombre            String    @db.VarChar(100)
  telefono          String    @db.VarChar(20)
  email             String    @db.VarChar(100) @unique
  id_administrador  Int
  
  // Relaciones
  administrador     Administrador @relation(fields: [id_administrador], references: [id])
  pedidos           Pedido[]
  
  @@map("cliente")
  @@index([id_administrador])
  @@index([nombre])
  @@index([telefono])
}

// ================================================================
// TABLA: pedidos
// ================================================================
model Pedido {
  id                Int           @id @default(autoincrement())
  id_cliente        Int
  fecha_pedido      DateTime      @default(now())
  fecha_entrega     DateTime
  fecha_delete      DateTime?
  id_administrador  Int
  
  // Relaciones
  cliente           Cliente       @relation(fields: [id_cliente], references: [id], onDelete: Cascade)
  administrador     Administrador @relation(fields: [id_administrador], references: [id])
  detalles          DetallePedido[]
  detallesPago      DetallePago[]
  
  @@map("pedidos")
  @@index([id_cliente])
  @@index([id_administrador])
  @@index([fecha_pedido])
  @@index([fecha_entrega])
  @@index([fecha_delete])
}

// ================================================================
// TABLA: producto
// ================================================================
model Producto {
  id                Int       @id @default(autoincrement())
  tipo              String    @db.VarChar(100)
  precio            Decimal   @db.Decimal(10,2)
  id_administrador  Int
  
  // Relaciones
  administrador     Administrador @relation(fields: [id_administrador], references: [id])
  detalles          DetallePedido[]
  
  @@map("producto")
  @@index([id_administrador])
  @@index([tipo])
}

// ================================================================
// TABLA: detalle_pedidos
// ================================================================
model DetallePedido {
  id              Int      @id @default(autoincrement())
  id_pedido       Int
  id_producto     Int
  cantidad        Int
  precio_unitario Decimal  @db.Decimal(10,2)
  paciente        String   @db.VarChar(100)
  id_estado       Int
  
  // Relaciones
  pedido          Pedido   @relation(fields: [id_pedido], references: [id], onDelete: Cascade)
  producto        Producto @relation(fields: [id_producto], references: [id])
  estado          Estado   @relation(fields: [id_estado], references: [id])
  
  @@map("detalle_pedidos")
  @@index([id_pedido])
  @@index([id_producto])
  @@index([id_estado])
}

// ================================================================
// TABLA: estado (Catálogo)
// ================================================================
model Estado {
  id            Int           @id @default(autoincrement())
  descripcion   String        @db.VarChar(50) @unique
  fecha_insert  DateTime      @default(now())
  fecha_delete  DateTime?
  
  // Relaciones
  detalles      DetallePedido[]
  
  @@map("estado")
  @@index([fecha_delete])
}

// ================================================================
// TABLA: pago
// ================================================================
model Pago {
  id                Int       @id @default(autoincrement())
  valor             Decimal   @db.Decimal(10,2)
  id_administrador  Int
  
  // Relaciones
  administrador     Administrador @relation(fields: [id_administrador], references: [id])
  detalles          DetallePago[]
  
  @@map("pago")
  @@index([id_administrador])
}

// ================================================================
// TABLA: detalle_pago
// ================================================================
model DetallePago {
  id         Int      @id @default(autoincrement())
  id_pago    Int
  id_pedido  Int
  valor      Decimal  @db.Decimal(10,2)
  fecha_pago DateTime
  
  // Relaciones
  pago       Pago     @relation(fields: [id_pago], references: [id], onDelete: Cascade)
  pedido     Pedido   @relation(fields: [id_pedido], references: [id], onDelete: Cascade)
  
  @@map("detalle_pago")
  @@index([id_pedido])
  @@index([id_pago])
  @@index([fecha_pago])
}

// ================================================================
// TABLA: auditoria (SIN RELACIONES)
// ================================================================
model Auditoria {
  id            Int      @id @default(autoincrement())
  usuario       String   @db.VarChar(50)
  fecha_accion  DateTime @default(now())
  accion        String   @db.VarChar(100)
  
  @@map("auditoria")
  @@index([fecha_accion])
  @@index([usuario])
}
